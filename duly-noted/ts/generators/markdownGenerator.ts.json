{"name":"./ts/generators/markdownGenerator.ts","lines":[{"number":0,"longComment":true,"comment":" !MarkdownGenerator/main"},{"number":1,"longComment":true,"comment":"# Markdown Generator"},{"number":2,"longComment":true,"comment":" @authors/chris"},{"number":3,"longComment":true,"comment":" @license"},{"number":4,"longComment":true,"comment":""},{"number":5,"longComment":true,"comment":"This is a generator that takes the reference maps produced by"},{"number":6,"longComment":true,"comment":"@ReferenceParser/parse and turns them into nice markdown documentation files."},{"number":7,"longComment":true,"comment":""},{"number":8,"longComment":true,"comment":"Markdown will be saved to the `outputDir` set in `duly-noted.json`"},{"number":9,"longComment":true,"comment":""},{"number":10,"code":""},{"number":11,"code":"import {IReferenceCollection, IAnchor, ITag, ReferenceCollection} from \"../classes/referenceCollection\";"},{"number":12,"code":"import {parseLoc} from \"../modules/referenceParser\";"},{"number":13,"code":"import {IConfig, IExternalReference} from \"../classes/IConfig\";"},{"number":14,"code":"import {readFiles, files} from \"node-dir\";"},{"number":15,"code":"import {IFile, ILine} from \"../classes/IFile\";"},{"number":16,"code":"import XRegExp = require(\"xregexp\");"},{"number":17,"code":"import {writeFileSync, mkdirSync, accessSync, F_OK, unlinkSync, readFileSync} from \"fs\";"},{"number":18,"code":"import mkdirp = require(\"mkdirp\");"},{"number":19,"code":"import * as path from \"path\";"},{"number":20,"code":"import _ = require(\"underscore\");"},{"number":21,"code":"import lineReader = require(\"line-reader\");"},{"number":22,"code":"import Q = require(\"q\");"},{"number":23,"code":""},{"number":24,"code":"import log4js = require(\"log4js\");"},{"number":25,"code":"let logger = log4js.getLogger(\"duly-noted::MarkdownGenerator\");"},{"number":26,"code":""},{"number":27,"code":""},{"number":28,"longComment":true,"comment":""},{"number":29,"longComment":true,"comment":"!interfaces/IMarkdownGenerator"},{"number":30,"longComment":true,"comment":""},{"number":31,"code":"export interface IMarkdownGenerator {"},{"number":32,"code":"    generate(): void;"},{"number":33,"code":"}"},{"number":34,"code":""},{"number":35,"longComment":true,"comment":" !MarkdownGenerator/class"},{"number":36,"longComment":true,"comment":"## Markdown Generator Class"},{"number":37,"longComment":true,"comment":""},{"number":38,"code":"export class MarkdownGenerator implements IMarkdownGenerator {"},{"number":39,"code":"    outputDir: string;"},{"number":40,"code":"    indexFile: string;"},{"number":41,"code":"    externalReferences: IExternalReference[];"},{"number":42,"code":"    anchorRegExp: RegExp;"},{"number":43,"code":"    linkRegExp: RegExp;"},{"number":44,"code":"    referenceCollection: ReferenceCollection;"},{"number":45,"code":"    tags: ITag[] = [];"},{"number":46,"code":"    readme: string;"},{"number":47,"code":"    projectName: string;"},{"number":48,"code":"    outputFiles: string[] = [];"},{"number":49,"code":"    htmlAnchors: boolean;"},{"number":50,"code":"    gitHubHtmlAnchors: boolean;"},{"number":51,"code":""},{"number":52,"longComment":true,"comment":" !MarkdownGenerator/constructor"},{"number":53,"longComment":true,"comment":"### Creates an instance of @MarkdownGenerator/class"},{"number":54,"longComment":true,"comment":""},{"number":55,"code":"    constructor(config: IConfig, logLevel?: string) {"},{"number":56,"code":"        logger.setLevel(logLevel || \"DEBUG\");"},{"number":57,"code":"        this.outputDir = config.outputDir;"},{"number":58,"code":"        this.externalReferences = JSON.parse(readFileSync(path.join(parseLoc, \"externalReferences.json\")).toString());"},{"number":59,"code":"        this.anchorRegExp = new RegExp(config.anchorRegExp);"},{"number":60,"code":"        this.linkRegExp = new RegExp(config.linkRegExp);"},{"number":61,"code":"        this.referenceCollection = new ReferenceCollection(\"\").inflate(JSON.parse(readFileSync(path.join(parseLoc, \"internalReferences.json\")).toString()));"},{"number":62,"code":"        this.tags = this.referenceCollection.getAllTags();"},{"number":63,"code":"        this.readme = config.readme;"},{"number":64,"code":"        this.projectName = config.projectName;"},{"number":65,"code":"        this.indexFile = config.indexFile;"},{"number":66,"code":""},{"number":67,"comment":" For a discussion anchors in markdown see @issue/4","code":""},{"number":68,"code":"        this.htmlAnchors = config.markdownGeneratorOptions.htmlAnchors;"},{"number":69,"code":"        this.gitHubHtmlAnchors = config.markdownGeneratorOptions.gitHubHtmlAnchors;"},{"number":70,"code":"    }"},{"number":71,"code":""},{"number":72,"longComment":true,"comment":" !MarkdownGenerator/generate"},{"number":73,"longComment":true,"comment":"## Generate Markdown Docs"},{"number":74,"longComment":true,"comment":"Creates Markdown docs for a set of file maps and reference maps set in @MarkdownGenerator/constructor ."},{"number":75,"longComment":true,"comment":""},{"number":76,"code":"    public generate(): Q.IPromise<{}> {"},{"number":77,"code":"        return Q.Promise((resolve, reject) => {"},{"number":78,"code":"            logger.info(\"Generating Markdown Docs.\");"},{"number":79,"code":"            let that = this;"},{"number":80,"code":"            this.outputFiles = [];"},{"number":81,"code":"            readFiles(parseLoc, {match: /.json$/, exclude: /internalReferences.json|externalReferences.json/, recursive: true}, (err, content, next) => {"},{"number":82,"code":"                that.proccessFile(err, content, next, that.outputDir);"},{"number":83,"code":"            }, (err, files) => {"},{"number":84,"code":"                let readme = \"\";"},{"number":85,"code":"                let i = 1;"},{"number":86,"code":""},{"number":87,"code":"                if (that.readme !== null) {"},{"number":88,"code":"                    lineReader.eachLine(that.readme, (line, last) => {"},{"number":89,"code":"                        let newLine = line;"},{"number":90,"code":"                        newLine = that.replaceLinks(newLine, that.readme, i);"},{"number":91,"code":"                        readme +=  \"\\n\" + newLine;"},{"number":92,"code":"                        i++;"},{"number":93,"code":"                    }, () => {"},{"number":94,"code":"                        that.generateIndexPage(readme);"},{"number":95,"code":"                        resolve(null);"},{"number":96,"code":"                    });"},{"number":97,"code":"                } else {"},{"number":98,"code":"                    that.generateIndexPage(\"\");"},{"number":99,"code":"                    resolve(null);"},{"number":100,"code":"                }"},{"number":101,"code":"            });"},{"number":102,"code":"        });"},{"number":103,"code":"    }"},{"number":104,"code":""},{"number":105,"longComment":true,"comment":" !MarkdownGenerator/processFiles"},{"number":106,"longComment":true,"comment":"## Process Files"},{"number":107,"longComment":true,"comment":"Processes the file map for a file, making output decisions based on "},{"number":108,"longComment":true,"comment":"code, comment, long comment "},{"number":109,"longComment":true,"comment":""},{"number":110,"code":"    proccessFile(err: Error, content: string, next: Function, outputDir: string): void {"},{"number":111,"code":"        let file: IFile = JSON.parse(content);"},{"number":112,"code":"        let that = this;"},{"number":113,"code":"        logger.debug(\"Processing \" + file.name);"},{"number":114,"code":""},{"number":115,"code":"        if (err) {"},{"number":116,"code":"            logger.error(err.message);"},{"number":117,"code":"        } else {"},{"number":118,"code":"            let file: IFile = JSON.parse(content);"},{"number":119,"code":"            let output: string = \"\";"},{"number":120,"code":"            let inCodeBlock = false;"},{"number":121,"code":""},{"number":122,"code":"            for (let i = 0; i < file.lines.length; i++) {"},{"number":123,"code":"                if (typeof(file.lines[i].comment) === \"string\" && file.lines[i].comment !== \"\" && file.lines[i].comment !== null) {"},{"number":124,"code":"                    file.lines[i].comment = this.replaceAnchors(file.lines[i].comment, file.name, i);"},{"number":125,"code":"                    file.lines[i].comment = this.replaceLinks(file.lines[i].comment, file.name, i);"},{"number":126,"code":"                }"},{"number":127,"code":"            }"},{"number":128,"code":""},{"number":129,"code":"            for (let i = 0; i < file.lines.length; i++) {"},{"number":130,"code":""},{"number":131,"comment":" Comment","code":""},{"number":132,"code":"                if (typeof(file.lines[i].comment) === \"string\" && file.lines[i].comment !== null) {"},{"number":133,"code":"                    if (inCodeBlock) {"},{"number":134,"code":"                        output += \"\\n\" + \"```\" ; // Close the current block of code. "},{"number":135,"code":"                        inCodeBlock = false;"},{"number":136,"code":"                    }"},{"number":137,"code":""},{"number":138,"code":"                    output += \"\\n\" + file.lines[i].comment;"},{"number":139,"code":"                }"},{"number":140,"code":""},{"number":141,"comment":" Code","code":""},{"number":142,"code":"                if (typeof(file.lines[i].code) === \"string\" && file.lines[i].code !== null) {"},{"number":143,"code":"                    if (!inCodeBlock) {"},{"number":144,"code":"                        output += \"\\n\" + \"```\" + file.type; // Open new code block. "},{"number":145,"code":"                        inCodeBlock = true;"},{"number":146,"code":"                    }"},{"number":147,"code":"                    output += \"\\n\" + file.lines[i].code;"},{"number":148,"code":"                }"},{"number":149,"code":"            }"},{"number":150,"code":""},{"number":151,"code":"            if (inCodeBlock) {"},{"number":152,"code":"                output += \"\\n\" + \"```\"; // Close the current block of code. "},{"number":153,"code":"                inCodeBlock = false;"},{"number":154,"code":"            }"},{"number":155,"code":""},{"number":156,"code":"            let filePathArray = path.join(outputDir, file.name + \".md\").split(\"/\");"},{"number":157,"code":"            filePathArray.pop();"},{"number":158,"code":"            let filePath = filePathArray.join(\"/\");"},{"number":159,"code":""},{"number":160,"code":"            mkdirp(filePath, function (err) {"},{"number":161,"code":"                if (err) {"},{"number":162,"code":"                    logger.fatal(err.message);"},{"number":163,"code":"                }"},{"number":164,"code":"                else {"},{"number":165,"code":"                    let fileName = path.join(outputDir, file.name + \".md\");"},{"number":166,"code":"                    that.outputFiles.push(fileName);"},{"number":167,"code":"                    logger.debug(\"Saving output for \" + file.type + \" file \" + file.name + \" as \" + fileName);"},{"number":168,"code":"                    writeFileSync(fileName, output, { flag: \"w\" });"},{"number":169,"code":"                }"},{"number":170,"code":"            });"},{"number":171,"code":""},{"number":172,"code":"            next();"},{"number":173,"code":"        }"},{"number":174,"code":"    }"},{"number":175,"code":""},{"number":176,"longComment":true,"comment":" !MarkdownGenerator/replaceAnchors"},{"number":177,"longComment":true,"comment":"## Replace Anchors"},{"number":178,"longComment":true,"comment":"Processes a comment line, replacing anchors with markdown anchor link tags"},{"number":179,"longComment":true,"comment":""},{"number":180,"code":"    replaceAnchors(comment: string,  fileName: string, line: number, position?: number): string {"},{"number":181,"code":"        let pos = position || 0;"},{"number":182,"code":""},{"number":183,"comment":" Look at the line for anchors - replace them with links. ","code":""},{"number":184,"code":"        let match = XRegExp.exec(comment, this.anchorRegExp, pos, false);"},{"number":185,"code":"        let replacementText;"},{"number":186,"code":""},{"number":187,"code":"        if (!match) {"},{"number":188,"code":"            return comment;"},{"number":189,"code":"        } else {"},{"number":190,"code":""},{"number":191,"code":"            let anchor = match[1].replace(/\\//g, \"-\").toLowerCase();"},{"number":192,"code":""},{"number":193,"longComment":true,"comment":""},{"number":194,"longComment":true,"comment":"Markdown doesn't natively support acnhors, but you can make them work "},{"number":195,"longComment":true,"comment":"with simple html. In GitHub, however, anchors are prefixed with 'user-content'"},{"number":196,"longComment":true,"comment":"For a discussion anchors in markdown see @issue/4"},{"number":197,"longComment":true,"comment":""},{"number":198,"code":"            if (this.htmlAnchors || this.gitHubHtmlAnchors) {"},{"number":199,"code":"                replacementText = '<a name=\"' + anchor + '\" id=\"' + anchor + '\" ></a>';"},{"number":200,"code":""},{"number":201,"code":"                if (this.gitHubHtmlAnchors) {"},{"number":202,"code":"                    replacementText += \"[🔗](#user-content-\" + anchor + \")\" + match[1];"},{"number":203,"code":"                } else {"},{"number":204,"code":"                    replacementText += \"[🔗](#\" + anchor + \")\" + match[1];"},{"number":205,"code":"                }"},{"number":206,"code":"            } else {"},{"number":207,"code":"                replacementText = \"\";"},{"number":208,"code":"            }"},{"number":209,"code":""},{"number":210,"code":"            comment = comment.replace(match[0], replacementText);"},{"number":211,"code":"            return this.replaceAnchors(comment, fileName, line, pos + match[0].length);"},{"number":212,"code":"        }"},{"number":213,"code":"    }"},{"number":214,"code":""},{"number":215,"longComment":true,"comment":" !MarkdownGenerator/replaceLinks"},{"number":216,"longComment":true,"comment":"## Replace Links"},{"number":217,"longComment":true,"comment":"Processes a comment line, replacing links with markdown links. "},{"number":218,"longComment":true,"comment":"This function calls itself recursively until all links are replaced."},{"number":219,"longComment":true,"comment":""},{"number":220,"code":"    replaceLinks(comment: string, fileName: string, line: number, position?: number) {"},{"number":221,"code":"        let pos = position || 0;"},{"number":222,"code":""},{"number":223,"code":"        let linkPrefix = this.getLinkPrefix(fileName);"},{"number":224,"code":""},{"number":225,"comment":" Look at the line for anchors - replace them with links. ","code":""},{"number":226,"code":"        let match = XRegExp.exec(comment, this.linkRegExp, pos, false);"},{"number":227,"code":""},{"number":228,"code":"        if (!match) {"},{"number":229,"code":"            return comment;"},{"number":230,"code":"        } else {"},{"number":231,"code":""},{"number":232,"comment":" Look external link.","code":""},{"number":233,"code":"            let tagArray = match[1].split(\"/\");"},{"number":234,"code":"            let externalTag = _.clone(_.findWhere(this.externalReferences, {anchor: tagArray[0]}));"},{"number":235,"code":"            if (externalTag) {"},{"number":236,"code":""},{"number":237,"code":"                for (let i = 1; i < tagArray.length; i++) {"},{"number":238,"code":"                    externalTag.path = externalTag.path.replace(\"::\", tagArray[i]);"},{"number":239,"code":"                }"},{"number":240,"code":""},{"number":241,"code":"                logger.debug(\"found external link: \" + externalTag.path);"},{"number":242,"code":"                let anchor = match[1].replace(/\\//g, \"-\").toLowerCase();"},{"number":243,"code":"                comment = comment.replace(match[0], \" [\" + match[1] + \"](\" + externalTag.path + \") \");"},{"number":244,"code":"                return this.replaceLinks(comment, fileName, line, pos + match[0].length);"},{"number":245,"code":"            }"},{"number":246,"code":""},{"number":247,"comment":" Look for internal link.","code":""},{"number":248,"code":"            let internalTag =  _.findWhere(this.tags, {anchor: match[1]});"},{"number":249,"code":"            if (!internalTag) {"},{"number":250,"comment":" If we can't match this link, then let's just stop processing this line and warn the user.","code":""},{"number":251,"code":"                logger.warn(\"link: \" + match[1] + \" in \" + fileName + \":\" + line + \":\" + pos + \" does not have a cooresponding anchor, so link cannot be created.\");"},{"number":252,"code":"                return comment;"},{"number":253,"code":"            } else {"},{"number":254,"code":"                logger.debug(\"found internal link: \" + match[1] + \" \" + internalTag.path);"},{"number":255,"code":"                let anchor = match[1].replace(/\\//g, \"-\").toLowerCase();"},{"number":256,"code":""},{"number":257,"comment":" Make GitHub-hosted Markdown adjustment. See @issue/4","code":""},{"number":258,"code":"                if (this.gitHubHtmlAnchors) {"},{"number":259,"code":"                    comment = comment.replace(match[0], \" [\" + match[1] + \"](\" + linkPrefix + internalTag.path + \".md#user-content-\" + anchor + \")\");"},{"number":260,"code":"                } else {"},{"number":261,"code":"                    comment = comment.replace(match[0], \" [\" + match[1] + \"](\" + linkPrefix + internalTag.path + \".md#\" + anchor + \")\");"},{"number":262,"code":"                }"},{"number":263,"code":"            }"},{"number":264,"code":"            return this.replaceLinks(comment, fileName, line, pos + match[0].length);"},{"number":265,"code":"        }"},{"number":266,"code":"    }"},{"number":267,"code":""},{"number":268,"longComment":true,"comment":" !MarkdownGenerator/generateIndexPage"},{"number":269,"longComment":true,"comment":"## Generates the \"Index Page\""},{"number":270,"longComment":true,"comment":"This generates the index page, listing all the link collections, "},{"number":271,"longComment":true,"comment":"and sucks in the user's defined README. "},{"number":272,"longComment":true,"comment":""},{"number":273,"code":"    generateIndexPage(readmeText?): void {"},{"number":274,"code":"        logger.info(\"generating Duly Noted Index file.\");"},{"number":275,"code":"        let that = this;"},{"number":276,"code":""},{"number":277,"code":"        let outputMap = {"},{"number":278,"code":"            project: this.projectName,"},{"number":279,"code":"            collections: [],"},{"number":280,"code":"            files: this.outputFiles,"},{"number":281,"code":"            readme: readmeText"},{"number":282,"code":"        };"},{"number":283,"code":""},{"number":284,"code":"        let collections = that.referenceCollection.getTagsByCollection();"},{"number":285,"code":""},{"number":286,"code":"        for (let i = 0; i < collections.length; i++) {"},{"number":287,"code":"            let anchors = _.clone(collections[i].anchors);"},{"number":288,"code":"            let name = collections[i].name.split(\"/\");"},{"number":289,"code":"            name.shift();"},{"number":290,"code":"            name.shift();"},{"number":291,"code":"            name = name.join(\"/\");"},{"number":292,"code":""},{"number":293,"code":"            for (let x = 0; x < anchors.length; x++) {"},{"number":294,"code":"                let anchor = anchors[x].linkStub.replace(/\\//g, \"-\").toLowerCase();"},{"number":295,"code":""},{"number":296,"code":"                anchors[x].path = anchors[x].path + \".md#\";"},{"number":297,"code":""},{"number":298,"comment":" Adjustment for gitHub anchor links. See @issue/4","code":""},{"number":299,"code":"                if (this.gitHubHtmlAnchors) {"},{"number":300,"code":"                    anchors[x].path += \"user-content-\";"},{"number":301,"code":"                }"},{"number":302,"code":""},{"number":303,"code":"                if (name !== \"\") {"},{"number":304,"code":"                    anchors[x].path += name.replace(/\\//g, \"-\").toLowerCase() + \"-\";"},{"number":305,"code":"                }"},{"number":306,"code":""},{"number":307,"code":"                anchors[x].path += anchor;"},{"number":308,"code":""},{"number":309,"code":"            }"},{"number":310,"code":""},{"number":311,"code":"            outputMap.collections.push({"},{"number":312,"code":"                name: name,"},{"number":313,"code":"                anchors: anchors"},{"number":314,"code":"            });"},{"number":315,"code":"        }"},{"number":316,"code":""},{"number":317,"code":"        let md = \"# \" + this.projectName + \" documentation \\n\";"},{"number":318,"code":""},{"number":319,"code":"        md += \"### Anchor Collections \\n\";"},{"number":320,"code":"        for (let i = 0; i < outputMap.collections.length; i++) {"},{"number":321,"code":"           md += \"\\n#### \" + outputMap.collections[i].name + \" \\n\";"},{"number":322,"code":""},{"number":323,"code":"           for (let x = 0; x < outputMap.collections[i].anchors.length; x++) {"},{"number":324,"code":"               md += \"* [\" + outputMap.collections[i].anchors[x].anchor + \"]\" + \"(\" + outputMap.collections[i].anchors[x].path + \") \\n\";"},{"number":325,"code":"           }"},{"number":326,"code":"        }"},{"number":327,"code":""},{"number":328,"code":"        md += \"\\n------------------------------ \\n\";"},{"number":329,"code":"        md += \"\\n### Documentation Files \\n\";"},{"number":330,"code":""},{"number":331,"code":"        for (let i = 0; i < outputMap.files.length; i++) {"},{"number":332,"code":""},{"number":333,"longComment":true,"comment":""},{"number":334,"longComment":true,"comment":"This shifts off the root folder b/c our index file is inside the output folder, "},{"number":335,"longComment":true,"comment":"not one level up. See @issue/5"},{"number":336,"longComment":true,"comment":"> EXAMPLE: "},{"number":337,"longComment":true,"comment":"> docs/myfile.ts.md is linked to as ./myfile.ts.md"},{"number":338,"longComment":true,"comment":""},{"number":339,"code":"            let path: any = outputMap.files[i].split(\"/\");"},{"number":340,"code":"            let name = path;"},{"number":341,"code":"            path.shift();"},{"number":342,"code":"            path.unshift(\".\");"},{"number":343,"code":"            path = path.join(\"/\");"},{"number":344,"code":"            name.shift();"},{"number":345,"code":"            name = name.join(\"/\");"},{"number":346,"code":""},{"number":347,"code":"            md += \"* [\" + name + \"](\" + path + \") \\n\";"},{"number":348,"code":"        }"},{"number":349,"code":"        md += \"\\n------------------------------ \\n\";"},{"number":350,"code":""},{"number":351,"code":"        md += outputMap.readme;"},{"number":352,"code":""},{"number":353,"code":"        writeFileSync(path.join(that.outputDir, that.indexFile), md, { flag: \"w\" });"},{"number":354,"code":"    }"},{"number":355,"code":""},{"number":356,"code":""},{"number":357,"longComment":true,"comment":" !MarkdownGenerator/getLinkPrefix"},{"number":358,"longComment":true,"comment":"Generate a link Prefix from a fileName"},{"number":359,"longComment":true,"comment":"> NOTE: Without this code, links will not properly navigated to deeply nested pages with relative linking."},{"number":360,"longComment":true,"comment":""},{"number":361,"code":"    getLinkPrefix(fileName: string): string {"},{"number":362,"code":"        let fileNameAsArray = fileName.split(\"/\");"},{"number":363,"code":"        let linkPrefix = \"\";"},{"number":364,"code":"        for (let i = 0; i < fileNameAsArray.length - 2; i++) {"},{"number":365,"code":"            linkPrefix += \"../\";"},{"number":366,"code":"        }"},{"number":367,"code":""},{"number":368,"code":"        return linkPrefix;"},{"number":369,"code":"    }"},{"number":370,"code":"}"},{"number":371,"code":""}],"type":"typescript"}