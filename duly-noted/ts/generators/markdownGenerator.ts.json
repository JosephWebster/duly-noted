{"name":"./ts/generators/markdownGenerator.ts","lines":[{"number":0,"longComment":true,"comment":""},{"number":1,"longComment":true,"comment":" # !MarkdownGenerator"},{"number":2,"longComment":true,"comment":" @authors/chris"},{"number":3,"longComment":true,"comment":" @license"},{"number":4,"comment":""},{"number":5,"code":""},{"number":6,"code":"import {IReferenceCollection, IAnchor, ITag, ReferenceCollection} from \"../classes/referenceCollection\";"},{"number":7,"code":"import {parseLoc} from \"../modules/referenceParser\";"},{"number":8,"code":"import {IConfig, IExternalReference} from \"../classes/IConfig\";"},{"number":9,"code":"import {readFiles, files} from \"node-dir\";"},{"number":10,"code":"import {IFile, ILine} from \"../classes/IFile\";"},{"number":11,"code":"import XRegExp = require(\"xregexp\");"},{"number":12,"code":"import {writeFileSync, mkdirSync, accessSync, F_OK, unlinkSync, readFileSync} from \"fs\";"},{"number":13,"code":"import mkdirp = require(\"mkdirp\");"},{"number":14,"code":"import * as path from \"path\";"},{"number":15,"code":"import _ = require(\"underscore\");"},{"number":16,"code":"import lineReader = require(\"line-reader\");"},{"number":17,"code":""},{"number":18,"code":"import log4js = require(\"log4js\");"},{"number":19,"code":"let logger = log4js.getLogger(\"duly-noted::MarkdownGenerator\");"},{"number":20,"code":""},{"number":21,"code":""},{"number":22,"longComment":true,"comment":""},{"number":23,"longComment":true,"comment":" !interfaces/IMarkdownGenerator"},{"number":24,"comment":""},{"number":25,"code":"export interface IMarkdownGenerator {"},{"number":26,"code":"    generate(): void;"},{"number":27,"code":"}"},{"number":28,"code":""},{"number":29,"longComment":true,"comment":""},{"number":30,"longComment":true,"comment":" ## !classes/MarkdownGenerator"},{"number":31,"comment":""},{"number":32,"code":"export class MarkdownGenerator implements IMarkdownGenerator {"},{"number":33,"code":"    outputDir: string;"},{"number":34,"code":"    indexFile: string;"},{"number":35,"code":"    externalReferences: IExternalReference[];"},{"number":36,"code":"    anchorRegExp: RegExp;"},{"number":37,"code":"    linkRegExp: RegExp;"},{"number":38,"code":"    referenceCollection: ReferenceCollection;"},{"number":39,"code":"    tags: ITag[] = [];"},{"number":40,"code":"    readme: string;"},{"number":41,"code":"    projectName: string;"},{"number":42,"code":"    outputFiles: string[] = [];"},{"number":43,"code":""},{"number":44,"longComment":true,"comment":""},{"number":45,"longComment":true,"comment":" ### Creates an instance of @classes/MarkdownGenerator"},{"number":46,"comment":""},{"number":47,"code":"    constructor(config: IConfig, logLevel?: string) {"},{"number":48,"code":"        logger.setLevel(logLevel || \"DEBUG\");"},{"number":49,"code":"        this.outputDir = config.outputDir;"},{"number":50,"code":"        this.externalReferences = JSON.parse(readFileSync(path.join(parseLoc, \"externalReferences.json\")).toString());"},{"number":51,"code":"        this.anchorRegExp = new RegExp(config.anchorRegExp);"},{"number":52,"code":"        this.linkRegExp = new RegExp(config.linkRegExp);"},{"number":53,"code":"        this.referenceCollection = new ReferenceCollection(\"\").inflate(JSON.parse(readFileSync(path.join(parseLoc, \"internalReferences.json\")).toString()));"},{"number":54,"code":"        this.tags = this.referenceCollection.getAllTags();"},{"number":55,"code":"        this.readme = config.readme;"},{"number":56,"code":"        this.projectName = config.projectName;"},{"number":57,"code":"        this.indexFile = config.indexFile;"},{"number":58,"code":"    }"},{"number":59,"code":""},{"number":60,"longComment":true,"comment":""},{"number":61,"longComment":true,"comment":" ## Generate Markdown Docs"},{"number":62,"longComment":true,"comment":" Creates Markdown docs for a set of file maps and reference maps set on @classes/MarkdownGenerator construction."},{"number":63,"comment":""},{"number":64,"code":"    public generate(): void {"},{"number":65,"code":"        logger.info(\"Generating Markdown Docs.\");"},{"number":66,"code":"        let that = this;"},{"number":67,"code":"        this.outputFiles = [];"},{"number":68,"code":"        readFiles(parseLoc, {match: /.json$/, exclude: /internalReferences.json|externalReferences.json/, recursive: true}, (err, content, next) => {"},{"number":69,"code":"            that.proccessFile(err, content, next, that.outputDir);"},{"number":70,"code":"        }, (err, files) => {"},{"number":71,"code":"            let readme = \"\";"},{"number":72,"code":"            let i = 1;"},{"number":73,"code":"            lineReader.eachLine(that.readme, (line, last) => {"},{"number":74,"code":"                let newLine = line;"},{"number":75,"code":"                newLine = that.replaceExternalLinks(newLine, that.readme, i);"},{"number":76,"code":"                newLine = that.replaceInternalLinks(newLine, that.readme, i);"},{"number":77,"code":"                readme +=  \"\\n\" + newLine;"},{"number":78,"code":"                i++;"},{"number":79,"code":"            }, () => {"},{"number":80,"code":"                that.generateIndexPage(readme);"},{"number":81,"code":"            });"},{"number":82,"code":"        });"},{"number":83,"code":"    }"},{"number":84,"code":""},{"number":85,"longComment":true,"comment":""},{"number":86,"longComment":true,"comment":" ## Process Files"},{"number":87,"longComment":true,"comment":" Processes the file map for a file, making output decisions based on"},{"number":88,"longComment":true,"comment":" code, comment, long comment presence"},{"number":89,"comment":""},{"number":90,"code":"    proccessFile(err: Error, content: string, next: Function, outputDir: string): void {"},{"number":91,"code":"        let file: IFile = JSON.parse(content);"},{"number":92,"code":"        let that = this;"},{"number":93,"code":"        logger.debug(\"Processing \" + file.name);"},{"number":94,"code":""},{"number":95,"code":"        if (err) {"},{"number":96,"code":"            logger.error(err.message);"},{"number":97,"code":"        } else {"},{"number":98,"code":"            let file: IFile = JSON.parse(content);"},{"number":99,"code":"            let output: string = \"\";"},{"number":100,"code":"            let inCodeBlock = false;"},{"number":101,"code":""},{"number":102,"code":"            for (let i = 0; i < file.lines.length; i++) {"},{"number":103,"code":"                if (typeof(file.lines[i].comment) === \"string\" && file.lines[i].comment !== \"\" && file.lines[i].comment !== null) {"},{"number":104,"code":"                    file.lines[i].comment = this.replaceAnchors(file.lines[i].comment, file.name, i);"},{"number":105,"code":"                    file.lines[i].comment = this.replaceExternalLinks(file.lines[i].comment, file.name, i);"},{"number":106,"code":"                    file.lines[i].comment = this.replaceInternalLinks(file.lines[i].comment, file.name, i);"},{"number":107,"code":"                }"},{"number":108,"code":"            }"},{"number":109,"code":""},{"number":110,"code":"            for (let i = 0; i < file.lines.length; i++) {"},{"number":111,"code":""},{"number":112,"comment":" Comment","code":"               "},{"number":113,"code":"                if (typeof(file.lines[i].comment) === \"string\" && file.lines[i].comment !== \"\" && file.lines[i].comment !== null) {"},{"number":114,"code":"                    if (inCodeBlock) {"},{"number":115,"comment":" Close the current block of code. ","code":"                        output += \"```\" + \"\\n\";"},{"number":116,"code":"                        inCodeBlock = false;"},{"number":117,"code":"                    }"},{"number":118,"code":""},{"number":119,"code":"                    output += file.lines[i].comment + \"\\n\" + \"\\n\";"},{"number":120,"code":"                }"},{"number":121,"code":""},{"number":122,"comment":" Code","code":"               "},{"number":123,"code":"                if (typeof(file.lines[i].code) === \"string\" && file.lines[i].code !== \"\" && file.lines[i].code !== null) {"},{"number":124,"code":"                    if (!inCodeBlock) {"},{"number":125,"comment":" Open new code block. ","code":"                        output += \"```\" + file.type +  \"\\n\";"},{"number":126,"code":"                        inCodeBlock = true;"},{"number":127,"code":"                    }"},{"number":128,"code":"                    output += file.lines[i].code + \"\\n\";"},{"number":129,"code":"                }"},{"number":130,"code":"            }"},{"number":131,"code":""},{"number":132,"code":"            if (inCodeBlock) {"},{"number":133,"comment":" Close the current block of code. ","code":"                output += \"```\" + \"\\n\";"},{"number":134,"code":"                inCodeBlock = false;"},{"number":135,"code":"            }"},{"number":136,"code":""},{"number":137,"code":"            let filePathArray = path.join(outputDir, file.name + \".md\").split(\"/\");"},{"number":138,"code":"            filePathArray.pop();"},{"number":139,"code":"            let filePath = filePathArray.join(\"/\");"},{"number":140,"code":""},{"number":141,"code":"            mkdirp(filePath, function (err) {"},{"number":142,"code":"                if (err) {"},{"number":143,"code":"                    logger.fatal(err.message);"},{"number":144,"code":"                }"},{"number":145,"code":"                else {"},{"number":146,"code":"                    let fileName = path.join(outputDir, file.name + \".md\");"},{"number":147,"code":"                    that.outputFiles.push(fileName);"},{"number":148,"code":"                    logger.debug(\"Saving output for \" + file.type + \" file \" + file.name + \" as \" + fileName);"},{"number":149,"code":"                    writeFileSync(fileName, output, { flag: \"w\" });"},{"number":150,"code":"                }"},{"number":151,"code":"            });"},{"number":152,"code":""},{"number":153,"code":"            next();"},{"number":154,"code":"        }"},{"number":155,"code":"    }"},{"number":156,"code":""},{"number":157,"longComment":true,"comment":""},{"number":158,"longComment":true,"comment":" ## Replace Anchors"},{"number":159,"longComment":true,"comment":" Processes a comment line, replacing anchors with markdown anchor link tags"},{"number":160,"comment":""},{"number":161,"code":"    replaceAnchors(comment: string,  fileName: string, line: number) {"},{"number":162,"code":"        let pos = 0;"},{"number":163,"code":"        let match;"},{"number":164,"code":"        let newComment: string = comment;"},{"number":165,"comment":" Look at the line for anchors - replace them with links. ","code":"       "},{"number":166,"code":"        while (match = XRegExp.exec(newComment, this.anchorRegExp, pos, false)) {"},{"number":167,"code":"            newComment =  newComment.substr(0, match.index) +"},{"number":168,"code":"            \"[\" + match[1] + \"](#\" + match[1] + \")\" +"},{"number":169,"code":"            newComment.substr(match.index + match[0].length);"},{"number":170,"code":""},{"number":171,"code":"            pos = match.index + match[0].length;"},{"number":172,"code":"        }"},{"number":173,"code":""},{"number":174,"code":"        return newComment;"},{"number":175,"code":"    }"},{"number":176,"code":""},{"number":177,"longComment":true,"comment":""},{"number":178,"longComment":true,"comment":" ## Replace Links"},{"number":179,"longComment":true,"comment":" > Run this AFTER external link replacement to ensure warning accuracy"},{"number":180,"longComment":true,"comment":" Processes a comment line, replacing links with markdown links"},{"number":181,"comment":""},{"number":182,"code":"    replaceInternalLinks(comment: string, fileName: string, line: number) {"},{"number":183,"code":"        let pos = 0;"},{"number":184,"code":"        let match;"},{"number":185,"code":"        let newComment: string = comment;"},{"number":186,"code":""},{"number":187,"code":"        let linkPrefix = this.getLinkPrefix(fileName);"},{"number":188,"code":""},{"number":189,"comment":" Look at the line for anchors - replace them with links. ","code":"       "},{"number":190,"code":"        while (match = XRegExp.exec(newComment, this.linkRegExp, pos, false)) {"},{"number":191,"code":"            let tag =  _.findWhere(this.tags, {anchor: match[1]});"},{"number":192,"code":"            if (!tag) {"},{"number":193,"code":"                logger.warn(\"link: \" + match[1] + \" in \" + fileName + \":\" + line + \" does not have a cooresponding anchor, so link cannot be created.\");"},{"number":194,"code":"            } else {"},{"number":195,"code":"                logger.debug(\"found internal link: \" + match[1] + \" \" + tag.path);"},{"number":196,"code":"                newComment =  comment.substr(0, match.index) +"},{"number":197,"code":"                \" [\" + match[1] + \"](\" + linkPrefix + tag.path + \".md#\" + match[1] + \") \" +"},{"number":198,"code":"                newComment.substr(match.index + match[0].length);"},{"number":199,"code":"            }"},{"number":200,"code":"            pos = match.index + match[0].length;"},{"number":201,"code":"        }"},{"number":202,"code":""},{"number":203,"code":"        return newComment;"},{"number":204,"code":"    }"},{"number":205,"code":""},{"number":206,"longComment":true,"comment":""},{"number":207,"longComment":true,"comment":" ## Replace External Links"},{"number":208,"longComment":true,"comment":" > Run this BEFORE internal link replacement"},{"number":209,"longComment":true,"comment":" Processes a comment line, replacing links with markdown links to external urls"},{"number":210,"comment":""},{"number":211,"code":"    replaceExternalLinks(comment: string, fileName: string, line: number) {"},{"number":212,"code":"        let pos = 0;"},{"number":213,"code":"        let match;"},{"number":214,"code":"        let newComment: string = comment;"},{"number":215,"code":""},{"number":216,"comment":" Look at the line for external references - replace them with links. ","code":"       "},{"number":217,"code":"        while (match = XRegExp.exec(newComment, this.linkRegExp, pos, false)) {"},{"number":218,"code":"            let tagArray = match[1].split(\"/\");"},{"number":219,"code":"            let tag =  _.findWhere(this.externalReferences, {anchor: tagArray[0]});"},{"number":220,"code":""},{"number":221,"code":"            if (tag) {"},{"number":222,"code":"                logger.debug(\"found external link: \" + match[1]);"},{"number":223,"code":"                for (let i = 1; i < tagArray.length; i++) {"},{"number":224,"code":"                    tag.path = tag.path.replace(\"::\", tagArray[i]);"},{"number":225,"code":"                }"},{"number":226,"code":""},{"number":227,"code":"                newComment =  comment.substr(0, match.index - 1) +"},{"number":228,"code":"                \" [\" + match[1] + \"](\" + tag.path + \") \" +"},{"number":229,"code":"                newComment.substr(match.index + match[0].length);"},{"number":230,"code":"            }"},{"number":231,"code":""},{"number":232,"code":"            pos = match.index + match[0].length;"},{"number":233,"code":"        }"},{"number":234,"code":"        return newComment;"},{"number":235,"code":"    }"},{"number":236,"code":""},{"number":237,"longComment":true,"comment":""},{"number":238,"longComment":true,"comment":" ## Generates the \"Index Page\""},{"number":239,"longComment":true,"comment":" This generates the index page, listing all the link collections,"},{"number":240,"longComment":true,"comment":" and sucks in the README."},{"number":241,"comment":""},{"number":242,"code":"    generateIndexPage(readmeText?): void {"},{"number":243,"code":"        logger.info(\"generating Duly Noted Index file.\");"},{"number":244,"code":"        let that = this;"},{"number":245,"code":""},{"number":246,"code":"        let outputMap = {"},{"number":247,"code":"            project: this.projectName,"},{"number":248,"code":"            collections: [],"},{"number":249,"code":"            files: this.outputFiles,"},{"number":250,"code":"            readme: readmeText"},{"number":251,"code":"        };"},{"number":252,"code":""},{"number":253,"code":"        let collections = that.referenceCollection.getTagsByCollection();"},{"number":254,"code":""},{"number":255,"code":"        for (let i = 0; i < collections.length; i++) {"},{"number":256,"code":"            let anchors = _.clone(collections[i].anchors);"},{"number":257,"code":"            for (let x = 0; x < anchors.length; x++) {"},{"number":258,"code":"                let linkPrefix = that.getLinkPrefix(anchors[x].path);"},{"number":259,"code":"                anchors[x].path = anchors[x].path + \".md#\" + anchors[x].linkStub;"},{"number":260,"code":"            }"},{"number":261,"code":""},{"number":262,"code":"            let name = collections[i].name.split(\"/\");"},{"number":263,"code":"            name.shift();"},{"number":264,"code":"            name.shift();"},{"number":265,"code":"            name = name.join(\"/\");"},{"number":266,"code":""},{"number":267,"code":"            outputMap.collections.push({"},{"number":268,"code":"                name: name,"},{"number":269,"code":"                anchors: anchors"},{"number":270,"code":"            });"},{"number":271,"code":"        }"},{"number":272,"code":""},{"number":273,"code":"        let md = \"# \" + this.projectName + \" documentation \\n\";"},{"number":274,"code":""},{"number":275,"code":"        md += \"### Collections \\n\";"},{"number":276,"code":"        for (let i = 0; i < outputMap.collections.length; i++) {"},{"number":277,"code":"           md += \"\\n#### \" + outputMap.collections[i].name + \" \\n\";"},{"number":278,"code":""},{"number":279,"code":"           for (let x = 0; x < outputMap.collections[i].anchors.length; x++) {"},{"number":280,"code":"               md += \"* [\" + outputMap.collections[i].anchors[x].anchor + \"]\" + \"(\" + outputMap.collections[i].anchors[x].path + \") \\n\";"},{"number":281,"code":"           }"},{"number":282,"code":"        }"},{"number":283,"code":""},{"number":284,"code":"        md += \"\\n------------------------------ \\n\";"},{"number":285,"code":"        md += \"\\n### Files \\n\";"},{"number":286,"code":""},{"number":287,"code":"        for (let i = 0; i < outputMap.files.length; i++) {"},{"number":288,"code":""},{"number":289,"comment":" This shifts off the root folder b/c our index file is inside the output folder, ","code":"           "},{"number":290,"comment":" not one level up. See !issues/5","code":"           "},{"number":291,"comment":" > EXAMPLE: ","code":"           "},{"number":292,"comment":" > docs/myfile.ts.md is linked to as ./myfile.ts.md","code":"           "},{"number":293,"code":"            let path: any = outputMap.files[i].split(\"/\");"},{"number":294,"code":"            let name = path;"},{"number":295,"code":"            path.shift();"},{"number":296,"code":"            path.unshift(\".\");"},{"number":297,"code":"            path = path.join(\"/\");"},{"number":298,"code":"            name.shift();"},{"number":299,"code":"            name = name.join(\"/\");"},{"number":300,"code":""},{"number":301,"code":"            md += \"* [\" + name + \"](\" + path + \") \\n\";"},{"number":302,"code":"        }"},{"number":303,"code":"        md += \"\\n------------------------------ \\n\";"},{"number":304,"code":""},{"number":305,"code":"        md += outputMap.readme;"},{"number":306,"code":""},{"number":307,"code":"        writeFileSync(path.join(that.outputDir, that.indexFile), md, { flag: \"w\" });"},{"number":308,"code":"    }"},{"number":309,"code":""},{"number":310,"longComment":true,"comment":""},{"number":311,"longComment":true,"comment":" Generate a link Prefix from a fileName"},{"number":312,"longComment":true,"comment":" > NOTE: Without this code, links will not properly navigated to deeply nested pages with relative linking."},{"number":313,"comment":""},{"number":314,"code":"    getLinkPrefix(fileName: string): string {"},{"number":315,"code":"        let fileNameAsArray = fileName.split(\"/\");"},{"number":316,"code":"        let linkPrefix = \"\";"},{"number":317,"code":"        for (let i = 0; i < fileNameAsArray.length - 2; i++) {"},{"number":318,"code":"            linkPrefix += \"../\";"},{"number":319,"code":"        }"},{"number":320,"code":""},{"number":321,"code":"        return linkPrefix;"},{"number":322,"code":"    }"},{"number":323,"code":"}"},{"number":324,"code":""}],"type":"typescript"}