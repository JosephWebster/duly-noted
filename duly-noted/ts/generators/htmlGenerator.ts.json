{"name":"./ts/generators/htmlGenerator.ts","lines":[{"number":0,"code":"import {IAnchor, ITag, ReferenceCollection} from \"../classes/referenceCollection\";"},{"number":1,"code":"import {parseLoc} from \"../modules/referenceParser\";"},{"number":2,"code":"import {Config, IExternalReference} from \"../classes/IConfig\";"},{"number":3,"code":"import {readFiles, files} from \"node-dir\";"},{"number":4,"code":"import {IFile, ILine} from \"../classes/IFile\";"},{"number":5,"code":"import {writeFileSync, mkdirSync, accessSync, F_OK, unlinkSync, readFileSync} from \"fs\";"},{"number":6,"code":"import mkdirp = require(\"mkdirp\");"},{"number":7,"code":"import * as path from \"path\";"},{"number":8,"code":"import XRegExp = require(\"xregexp\");"},{"number":9,"code":"import * as handlebars from \"handlebars\";"},{"number":10,"code":"import * as marked from \"marked\";"},{"number":11,"code":"import * as fse from \"fs-extra\";"},{"number":12,"code":"import _ = require(\"underscore\");"},{"number":13,"code":""},{"number":14,"code":"import log4js = require(\"log4js\");"},{"number":15,"code":"let logger = log4js.getLogger(\"duly-noted::HtmlGenerator\");"},{"number":16,"code":""},{"number":17,"code":""},{"number":18,"code":"export interface IHtmlGenerator {"},{"number":19,"code":""},{"number":20,"code":"}"},{"number":21,"code":""},{"number":22,"code":"export class HtmlGenerator implements IHtmlGenerator {"},{"number":23,"code":"    outputDir: string;"},{"number":24,"code":"    collection: ReferenceCollection;"},{"number":25,"code":"    anchorRegExp: RegExp;"},{"number":26,"code":"    linkRegExp: RegExp;"},{"number":27,"code":"    template: any;"},{"number":28,"code":"    indexTemplate: any;"},{"number":29,"code":"    projectPath: string;"},{"number":30,"code":"    referenceCollection: ReferenceCollection;"},{"number":31,"code":"    tags: ITag[] = [];"},{"number":32,"code":"    externalReferences: IExternalReference[];"},{"number":33,"code":"    readme: string;"},{"number":34,"code":"    projectName: string;"},{"number":35,"code":""},{"number":36,"code":"    constructor(config: Config) {"},{"number":37,"code":"        this.outputDir = config.outputDir;"},{"number":38,"code":"        this.collection = JSON.parse(readFileSync(path.join(parseLoc, \"internalReferences.json\")).toString());"},{"number":39,"code":"        this.anchorRegExp = new RegExp(config.anchorRegExp);"},{"number":40,"code":"        this.linkRegExp = new RegExp(config.linkRegExp);"},{"number":41,"code":"        this.referenceCollection = new ReferenceCollection(\"\").inflate(JSON.parse(readFileSync(path.join(parseLoc, \"internalReferences.json\")).toString()));"},{"number":42,"code":"        this.externalReferences = JSON.parse(readFileSync(path.join(parseLoc, \"externalReferences.json\")).toString());"},{"number":43,"code":"        this.tags = this.referenceCollection.getAllTags();"},{"number":44,"code":"        let projectPathArray = __dirname.split(\"/\");"},{"number":45,"code":"        projectPathArray.pop();"},{"number":46,"code":"        this.projectPath = projectPathArray.join(\"/\");"},{"number":47,"code":""},{"number":48,"code":"        this.template = handlebars.compile(readFileSync(path.join(this.projectPath, \"templates\", \"stacked.html\")).toString());"},{"number":49,"code":"        this.indexTemplate = handlebars.compile(readFileSync(path.join(this.projectPath, \"templates\", \"index.html\")).toString());"},{"number":50,"code":""},{"number":51,"code":"        this.projectName = config.projectName;"},{"number":52,"code":"        this.readme = config.readme;"},{"number":53,"code":""},{"number":54,"code":"        handlebars.registerHelper(\"md\", this.markdownHelper);"},{"number":55,"code":"        handlebars.registerHelper(\"ifCond\", this.ifCondHelper);"},{"number":56,"code":"    }"},{"number":57,"code":""},{"number":58,"code":"    public generate(cleanUp?: boolean): void {"},{"number":59,"code":"        let that = this;"},{"number":60,"code":"        let clean = cleanUp || false;"},{"number":61,"code":"        readFiles(parseLoc, {match: /.json$/, exclude: /internalReferences.json|externalReferences.json/, recursive: true}, (err, content, next) => {"},{"number":62,"code":"            that.proccessFile(err, content, next, that.outputDir);"},{"number":63,"code":"        }, (err, files) => {"},{"number":64,"code":"            that.generateIndexPage();"},{"number":65,"code":"            if (clean) {"},{"number":66,"code":"                that.cleanUp(err, files);"},{"number":67,"code":"            }"},{"number":68,"code":"        });"},{"number":69,"code":""},{"number":70,"code":"        fse.copySync(path.join(this.projectPath, \"templates\", \"highlight.pack.js\"), path.join(this.outputDir, \"scripts/highlight.js\"));"},{"number":71,"code":"        fse.copySync(path.join(this.projectPath, \"templates\", \"css\", \"default.css\"), path.join(this.outputDir, \"css/default.css\"));"},{"number":72,"code":"    }"},{"number":73,"code":""},{"number":74,"code":"    proccessFile(err: Error, content: string, next: Function, outputDir: string): void {"},{"number":75,"code":"        let file: IFile = JSON.parse(content);"},{"number":76,"code":"        logger.info(\"Processing \" + file.name);"},{"number":77,"code":""},{"number":78,"code":""},{"number":79,"code":"        for (let i = 0; i < file.lines.length; i++) {"},{"number":80,"code":"            if (typeof(file.lines[i].comment) === \"string\" && file.lines[i].comment !== \"\" && file.lines[i].comment !== null) {"},{"number":81,"code":"                file.lines[i].comment = this.replaceAnchors(file.lines[i].comment, file.name, i);"},{"number":82,"code":"                file.lines[i].comment = this.replaceExternalLinks(file.lines[i].comment, file.name, i);"},{"number":83,"code":"                file.lines[i].comment = this.replaceInternalLinks(file.lines[i].comment, file.name, i);"},{"number":84,"code":"            }"},{"number":85,"code":"        }"},{"number":86,"code":""},{"number":87,"code":"        let outputMap = {"},{"number":88,"code":"            project: this.projectName,"},{"number":89,"code":"            items: [],"},{"number":90,"code":"            type: file.name,"},{"number":91,"code":"            name: file.type,"},{"number":92,"code":"            linkPrefix: this.getLinkPrefix(file.name)"},{"number":93,"code":"        };"},{"number":94,"code":""},{"number":95,"code":"         for (let i = 0; i < file.lines.length; i++) {"},{"number":96,"code":"            if (typeof(file.lines[i].comment) === \"string\" && file.lines[i].comment !== \"\" && file.lines[i].comment !== null) {"},{"number":97,"code":"                if (outputMap.items.length > 0 && outputMap.items[outputMap.items.length - 1].type === \"comment\") {"},{"number":98,"code":"                     outputMap.items[outputMap.items.length - 1].content +=  \"\\n\" + file.lines[i].comment;"},{"number":99,"code":"                } else {"},{"number":100,"code":"                     outputMap.items.push({content: file.lines[i].comment, type: \"comment\", longComment: file.lines[i].longComment || false });"},{"number":101,"code":"                }"},{"number":102,"code":"            }"},{"number":103,"code":""},{"number":104,"code":"            if (typeof(file.lines[i].code) === \"string\" && file.lines[i].code !== \"\" && file.lines[i].code !== null) {"},{"number":105,"code":"                if (outputMap.items.length > 0 && outputMap.items[outputMap.items.length - 1].type === \"code\") {"},{"number":106,"code":"                     outputMap.items[outputMap.items.length - 1].content  +=  \"\\n\" + file.lines[i].code;"},{"number":107,"code":"                } else {"},{"number":108,"code":"                    outputMap.items.push({content: file.lines[i].code, type: \"code\", lang: file.type});"},{"number":109,"code":"                }"},{"number":110,"code":"            }"},{"number":111,"code":"         }"},{"number":112,"code":"        let output = this.template(outputMap);"},{"number":113,"code":""},{"number":114,"comment":" let outputMap = file;","code":"       "},{"number":115,"comment":" outputMap.linkPrefix = this.getLinkPrefix(file.name);","code":"       "},{"number":116,"comment":" outputMap.project = this.projectName;","code":"       "},{"number":117,"comment":" let output = this.template(outputMap);","code":"       "},{"number":118,"code":"        let filePathArray = path.join(outputDir, file.name + \".md\").split(\"/\");"},{"number":119,"code":"        filePathArray.pop();"},{"number":120,"code":"        let filePath = filePathArray.join(\"/\");"},{"number":121,"code":""},{"number":122,"code":"        mkdirp(filePath, function (err) {"},{"number":123,"code":"            if (err) {"},{"number":124,"code":"                logger.fatal(err.message);"},{"number":125,"code":"            }"},{"number":126,"code":"            else {"},{"number":127,"code":"                logger.info(\"Saving output for \" + file.type + \" file \" + file.name);"},{"number":128,"code":"                writeFileSync(path.join(outputDir, file.name + \".html\"), output, { flag: \"w\" });"},{"number":129,"code":"                next();"},{"number":130,"code":"            }"},{"number":131,"code":"        });"},{"number":132,"code":"    }"},{"number":133,"code":""},{"number":134,"code":"    replaceAnchors(comment: string,  fileName: string, line: number) {"},{"number":135,"code":"        let pos = 0;"},{"number":136,"code":"        let match;"},{"number":137,"code":"        let newComment: string = comment;"},{"number":138,"comment":" Look at the line for anchors - replace them with links. ","code":"       "},{"number":139,"code":"        while (match = XRegExp.exec(newComment, this.anchorRegExp, pos, false)) {"},{"number":140,"code":"            newComment =  newComment.substr(0, match.index) +"},{"number":141,"code":"            \" <a name=\\\"\" + match[1] + \"\\\"><span class=\\\"glyphicon glyphicon-link\\\" aria-hidden=\\\"true\\\"></span>\" + match[1] + \"</a> \" +"},{"number":142,"code":"            newComment.substr(match.index + match[0].length);"},{"number":143,"code":""},{"number":144,"code":"            pos = match.index + match[0].length;"},{"number":145,"code":"        }"},{"number":146,"code":""},{"number":147,"code":"        return newComment;"},{"number":148,"code":"    }"},{"number":149,"code":""},{"number":150,"code":"    replaceInternalLinks(comment: string, fileName: string, line: number) {"},{"number":151,"code":"        let pos = 0;"},{"number":152,"code":"        let match;"},{"number":153,"code":"        let newComment: string = comment;"},{"number":154,"code":""},{"number":155,"code":"        let linkPrefix = this.getLinkPrefix(fileName);"},{"number":156,"code":""},{"number":157,"comment":" Look at the line for anchors - replace them with links. ","code":"       "},{"number":158,"code":"        while (match = XRegExp.exec(newComment, this.linkRegExp, pos, false)) {"},{"number":159,"code":"            let tag =  _.findWhere(this.tags, {anchor: match[1]});"},{"number":160,"code":"            if (!tag) {"},{"number":161,"code":"                logger.error(\"link: \" + match[1] + \" in \" + fileName + \":\" + line + \" does not have a cooresponding anchor, so link cannot be created.\");"},{"number":162,"code":"            } else {"},{"number":163,"code":"                logger.debug(\"found internal link: \" + match[1]);"},{"number":164,"code":"                newComment =  comment.substr(0, match.index) +"},{"number":165,"code":"                \" [\" + match[1] + \"](\" + linkPrefix + tag.path + \".html#\" + match[1] + \") \" +"},{"number":166,"code":"                newComment.substr(match.index + match[0].length);"},{"number":167,"code":"            }"},{"number":168,"code":"            pos = match.index + match[0].length;"},{"number":169,"code":"        }"},{"number":170,"code":""},{"number":171,"code":"        return newComment;"},{"number":172,"code":"    }"},{"number":173,"code":""},{"number":174,"code":"    replaceExternalLinks(comment: string, fileName: string, line: number) {"},{"number":175,"code":"        let pos = 0;"},{"number":176,"code":"        let match;"},{"number":177,"code":"        let newComment: string = comment;"},{"number":178,"code":""},{"number":179,"comment":" Look at the line for external references - replace them with links. ","code":"       "},{"number":180,"code":"        while (match = XRegExp.exec(newComment, this.linkRegExp, pos, false)) {"},{"number":181,"code":"            let tagArray = match[1].split(\"/\");"},{"number":182,"code":"            let tag =  _.findWhere(this.externalReferences, {anchor: tagArray[0]});"},{"number":183,"code":""},{"number":184,"code":"            if (tag) {"},{"number":185,"code":"                logger.debug(\"found external link: \" + match[1]);"},{"number":186,"code":"                for (let i = 1; i < tagArray.length; i++) {"},{"number":187,"code":"                    tag.path = tag.path.replace(\"::\", tagArray[i]);"},{"number":188,"code":"                }"},{"number":189,"code":""},{"number":190,"code":"                newComment =  comment.substr(0, match.index - 1) +"},{"number":191,"code":"                \" [\" + match[1] + \"](\" + tag.path + \") \" +"},{"number":192,"code":"                newComment.substr(match.index + match[0].length);"},{"number":193,"code":"            }"},{"number":194,"code":""},{"number":195,"code":"            pos = match.index + match[0].length;"},{"number":196,"code":"        }"},{"number":197,"code":"        return newComment;"},{"number":198,"code":"    }"},{"number":199,"code":""},{"number":200,"code":"    generateIndexPage(): void {"},{"number":201,"code":"        logger.info(\"generating index.html\");"},{"number":202,"code":"        let that = this;"},{"number":203,"code":""},{"number":204,"code":"        let outputMap = {"},{"number":205,"code":"            project: this.projectName,"},{"number":206,"code":"            collections: [],"},{"number":207,"code":"            files: [],"},{"number":208,"code":"            readme: \"\""},{"number":209,"code":"        };"},{"number":210,"code":""},{"number":211,"comment":" collections","code":"       "},{"number":212,"code":"        let collections = that.referenceCollection.getTagsByCollection();"},{"number":213,"code":""},{"number":214,"code":"        for (let i = 0; i < collections.length; i++) {"},{"number":215,"code":"            let anchors = _.clone(collections[i].anchors);"},{"number":216,"code":"            for (let x = 0; x < anchors.length; x++) {"},{"number":217,"code":"                let linkPrefix = that.getLinkPrefix(anchors[x].path);"},{"number":218,"code":"                anchors[x].path = anchors[x].path + \".html#\" + anchors[x].linkStub;"},{"number":219,"code":"            }"},{"number":220,"code":"            outputMap.collections.push({"},{"number":221,"code":"                name: collections[i].name,"},{"number":222,"code":"                anchors: anchors"},{"number":223,"code":"            });"},{"number":224,"code":"        }"},{"number":225,"code":""},{"number":226,"code":"        files(this.outputDir, (error, files) => {"},{"number":227,"code":""},{"number":228,"comment":" Files","code":"           "},{"number":229,"code":"            for (let i = 0; i < files.length; i++) {"},{"number":230,"code":"                let fileNameArray = files[i].split(\".\");"},{"number":231,"code":"                let extension = fileNameArray[fileNameArray.length - 1];"},{"number":232,"code":"                if (extension === \"html\") {"},{"number":233,"code":"                    let pathArray: string[] = files[i].split(\"/\");"},{"number":234,"comment":" shift the output dir off the file name.","code":"                    pathArray.shift();"},{"number":235,"code":"                    let path = pathArray.join(\"/\");"},{"number":236,"code":"                    outputMap.files.push({path: path});"},{"number":237,"code":"                }"},{"number":238,"code":"            }"},{"number":239,"code":""},{"number":240,"code":"            outputMap.readme = readFileSync(that.readme).toString();"},{"number":241,"code":"            let output = this.indexTemplate(outputMap);"},{"number":242,"code":"            writeFileSync(path.join(that.outputDir, \"index.html\"), output, { flag: \"w\" });"},{"number":243,"code":"        });"},{"number":244,"code":"    }"},{"number":245,"code":""},{"number":246,"code":"    cleanUp(err, files) {"},{"number":247,"code":"         if (err) {"},{"number":248,"code":"            logger.error(err.message);"},{"number":249,"code":"        } else {"},{"number":250,"code":"            for (let i = 0; i < files.length; i++) {"},{"number":251,"code":"                unlinkSync(files[i]);"},{"number":252,"code":"            }"},{"number":253,"code":"        }"},{"number":254,"code":"    }"},{"number":255,"code":""},{"number":256,"comment":" > NOTE: Without this code, the link will not properly navigated deeply nested pages with relative linking.","code":"   "},{"number":257,"code":"    getLinkPrefix(fileName: string): string {"},{"number":258,"code":"        let fileNameAsArray = fileName.split(\"/\");"},{"number":259,"code":"        let linkPrefix = \"\";"},{"number":260,"code":"        for (let i = 0; i < fileNameAsArray.length - 2; i++) {"},{"number":261,"code":"            linkPrefix += \"../\";"},{"number":262,"code":"        }"},{"number":263,"code":""},{"number":264,"code":"        return linkPrefix;"},{"number":265,"code":"    }"},{"number":266,"code":""},{"number":267,"code":"    markdownHelper(context, options) {"},{"number":268,"code":"       return marked(context);"},{"number":269,"code":"    }"},{"number":270,"code":""},{"number":271,"code":"    ifCondHelper(v1, v2, options) {"},{"number":272,"code":"        if (v1 === v2) {"},{"number":273,"code":"            return options.fn(this);"},{"number":274,"code":"        }"},{"number":275,"code":"        return options.inverse(this);"},{"number":276,"code":"    };"},{"number":277,"code":"}"}],"type":"typescript"}