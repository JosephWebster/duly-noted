{"name":"./ts/generators/markdownGenerator.ts","lines":[{"number":0,"longComment":true,"comment":""},{"number":1,"longComment":true,"comment":" # !MarkdownGenerator"},{"number":2,"longComment":true,"comment":" @authors/chris"},{"number":3,"longComment":true,"comment":" @license"},{"number":4,"comment":""},{"number":5,"code":""},{"number":6,"code":"import {IReferenceCollection, IAnchor, ITag, ReferenceCollection} from \"../classes/referenceCollection\";"},{"number":7,"code":"import {parseLoc} from \"../modules/referenceParser\";"},{"number":8,"code":"import {IConfig, IExternalReference} from \"../classes/IConfig\";"},{"number":9,"code":"import {readFiles, files} from \"node-dir\";"},{"number":10,"code":"import {IFile, ILine} from \"../classes/IFile\";"},{"number":11,"code":"import XRegExp = require(\"xregexp\");"},{"number":12,"code":"import {writeFileSync, mkdirSync, accessSync, F_OK, unlinkSync, readFileSync} from \"fs\";"},{"number":13,"code":"import mkdirp = require(\"mkdirp\");"},{"number":14,"code":"import * as path from \"path\";"},{"number":15,"code":"import _ = require(\"underscore\");"},{"number":16,"code":"import lineReader = require(\"line-reader\");"},{"number":17,"code":""},{"number":18,"code":"import log4js = require(\"log4js\");"},{"number":19,"code":"let logger = log4js.getLogger(\"duly-noted::MarkdownGenerator\");"},{"number":20,"code":""},{"number":21,"code":""},{"number":22,"longComment":true,"comment":""},{"number":23,"longComment":true,"comment":" !interfaces/IMarkdownGenerator"},{"number":24,"comment":""},{"number":25,"code":"export interface IMarkdownGenerator {"},{"number":26,"code":"    generate(): void;"},{"number":27,"code":"}"},{"number":28,"code":""},{"number":29,"longComment":true,"comment":""},{"number":30,"longComment":true,"comment":" ## !classes/MarkdownGenerator"},{"number":31,"comment":""},{"number":32,"code":"export class MarkdownGenerator implements IMarkdownGenerator {"},{"number":33,"code":"    outputDir: string;"},{"number":34,"code":"    externalReferences: IExternalReference[];"},{"number":35,"code":"    anchorRegExp: RegExp;"},{"number":36,"code":"    linkRegExp: RegExp;"},{"number":37,"code":"    referenceCollection: ReferenceCollection;"},{"number":38,"code":"    tags: ITag[] = [];"},{"number":39,"code":"    readme: string;"},{"number":40,"code":"    projectName: string;"},{"number":41,"code":"    outputFiles: string[] = [];"},{"number":42,"code":""},{"number":43,"longComment":true,"comment":""},{"number":44,"longComment":true,"comment":" ### Creates an instance of @classes/MarkdownGenerator"},{"number":45,"comment":""},{"number":46,"code":"    constructor(config: IConfig, logLevel?: string) {"},{"number":47,"code":"        logger.setLevel(logLevel || \"DEBUG\");"},{"number":48,"code":"        this.outputDir = config.outputDir;"},{"number":49,"code":"        this.externalReferences = JSON.parse(readFileSync(path.join(parseLoc, \"externalReferences.json\")).toString());"},{"number":50,"code":"        this.anchorRegExp = new RegExp(config.anchorRegExp);"},{"number":51,"code":"        this.linkRegExp = new RegExp(config.linkRegExp);"},{"number":52,"code":"        this.referenceCollection = new ReferenceCollection(\"\").inflate(JSON.parse(readFileSync(path.join(parseLoc, \"internalReferences.json\")).toString()));"},{"number":53,"code":"        this.tags = this.referenceCollection.getAllTags();"},{"number":54,"code":"        this.readme = config.readme;"},{"number":55,"code":"        this.projectName = config.projectName;"},{"number":56,"code":"    }"},{"number":57,"code":""},{"number":58,"longComment":true,"comment":""},{"number":59,"longComment":true,"comment":" ## Generate Markdown Docs"},{"number":60,"longComment":true,"comment":" Creates Markdown docs for a set of file maps and reference maps set on @classes/MarkdownGenerator construction."},{"number":61,"comment":""},{"number":62,"code":"    public generate(): void {"},{"number":63,"code":"        logger.info(\"Generating Markdown Docs.\");"},{"number":64,"code":"        let that = this;"},{"number":65,"code":"        this.outputFiles = [];"},{"number":66,"code":"        readFiles(parseLoc, {match: /.json$/, exclude: /internalReferences.json|externalReferences.json/, recursive: true}, (err, content, next) => {"},{"number":67,"code":"            that.proccessFile(err, content, next, that.outputDir);"},{"number":68,"code":"        }, (err, files) => {"},{"number":69,"code":"            let readme = \"\";"},{"number":70,"code":"            let i = 1;"},{"number":71,"code":"            lineReader.eachLine(that.readme, (line, last) => {"},{"number":72,"code":"                let newLine = line;"},{"number":73,"code":"                newLine = that.replaceExternalLinks(newLine, that.readme, i);"},{"number":74,"code":"                newLine = that.replaceInternalLinks(newLine, that.readme, i);"},{"number":75,"code":"                readme +=  \"\\n\" + newLine;"},{"number":76,"code":"                i++;"},{"number":77,"code":"            }, () => {"},{"number":78,"code":"                that.generateIndexPage(readme);"},{"number":79,"code":"            });"},{"number":80,"code":"        });"},{"number":81,"code":"    }"},{"number":82,"code":""},{"number":83,"longComment":true,"comment":""},{"number":84,"longComment":true,"comment":" ## Process Files"},{"number":85,"longComment":true,"comment":" Processes the file map for a file, making output decisions based on"},{"number":86,"longComment":true,"comment":" code, comment, long comment presence"},{"number":87,"comment":""},{"number":88,"code":"    proccessFile(err: Error, content: string, next: Function, outputDir: string): void {"},{"number":89,"code":"        let file: IFile = JSON.parse(content);"},{"number":90,"code":"        let that = this;"},{"number":91,"code":"        logger.debug(\"Processing \" + file.name);"},{"number":92,"code":""},{"number":93,"code":"        if (err) {"},{"number":94,"code":"            logger.error(err.message);"},{"number":95,"code":"        } else {"},{"number":96,"code":"            let file: IFile = JSON.parse(content);"},{"number":97,"code":"            let output: string = \"\";"},{"number":98,"code":"            let inCodeBlock = false;"},{"number":99,"code":""},{"number":100,"code":"            for (let i = 0; i < file.lines.length; i++) {"},{"number":101,"code":"                if (typeof(file.lines[i].comment) === \"string\" && file.lines[i].comment !== \"\" && file.lines[i].comment !== null) {"},{"number":102,"code":"                    file.lines[i].comment = this.replaceAnchors(file.lines[i].comment, file.name, i);"},{"number":103,"code":"                    file.lines[i].comment = this.replaceExternalLinks(file.lines[i].comment, file.name, i);"},{"number":104,"code":"                    file.lines[i].comment = this.replaceInternalLinks(file.lines[i].comment, file.name, i);"},{"number":105,"code":"                }"},{"number":106,"code":"            }"},{"number":107,"code":""},{"number":108,"code":"            for (let i = 0; i < file.lines.length; i++) {"},{"number":109,"code":""},{"number":110,"comment":" Comment","code":"               "},{"number":111,"code":"                if (typeof(file.lines[i].comment) === \"string\" && file.lines[i].comment !== \"\" && file.lines[i].comment !== null) {"},{"number":112,"code":"                    if (inCodeBlock) {"},{"number":113,"comment":" Close the current block of code. ","code":"                        output += \"```\" + \"\\n\";"},{"number":114,"code":"                        inCodeBlock = false;"},{"number":115,"code":"                    }"},{"number":116,"code":""},{"number":117,"code":"                    output += file.lines[i].comment + \"\\n\" + \"\\n\";"},{"number":118,"code":"                }"},{"number":119,"code":""},{"number":120,"comment":" Code","code":"               "},{"number":121,"code":"                if (typeof(file.lines[i].code) === \"string\" && file.lines[i].code !== \"\" && file.lines[i].code !== null) {"},{"number":122,"code":"                    if (!inCodeBlock) {"},{"number":123,"comment":" Open new code block. ","code":"                        output += \"```\" + file.type +  \"\\n\";"},{"number":124,"code":"                        inCodeBlock = true;"},{"number":125,"code":"                    }"},{"number":126,"code":"                    output += file.lines[i].code + \"\\n\";"},{"number":127,"code":"                }"},{"number":128,"code":"            }"},{"number":129,"code":""},{"number":130,"code":"            if (inCodeBlock) {"},{"number":131,"comment":" Close the current block of code. ","code":"                output += \"```\" + \"\\n\";"},{"number":132,"code":"                inCodeBlock = false;"},{"number":133,"code":"            }"},{"number":134,"code":""},{"number":135,"code":"            let filePathArray = path.join(outputDir, file.name + \".md\").split(\"/\");"},{"number":136,"code":"            filePathArray.pop();"},{"number":137,"code":"            let filePath = filePathArray.join(\"/\");"},{"number":138,"code":""},{"number":139,"code":"            mkdirp(filePath, function (err) {"},{"number":140,"code":"                if (err) {"},{"number":141,"code":"                    logger.fatal(err.message);"},{"number":142,"code":"                }"},{"number":143,"code":"                else {"},{"number":144,"code":"                    let fileName = path.join(outputDir, file.name + \".md\");"},{"number":145,"code":"                    that.outputFiles.push(fileName);"},{"number":146,"code":"                    logger.debug(\"Saving output for \" + file.type + \" file \" + file.name + \" as \" + fileName);"},{"number":147,"code":"                    writeFileSync(fileName, output, { flag: \"w\" });"},{"number":148,"code":"                }"},{"number":149,"code":"            });"},{"number":150,"code":""},{"number":151,"code":"            next();"},{"number":152,"code":"        }"},{"number":153,"code":"    }"},{"number":154,"code":""},{"number":155,"longComment":true,"comment":""},{"number":156,"longComment":true,"comment":" ## Replace Anchors"},{"number":157,"longComment":true,"comment":" Processes a comment line, replacing anchors with markdown anchor link tags"},{"number":158,"comment":""},{"number":159,"code":"    replaceAnchors(comment: string,  fileName: string, line: number) {"},{"number":160,"code":"        let pos = 0;"},{"number":161,"code":"        let match;"},{"number":162,"code":"        let newComment: string = comment;"},{"number":163,"comment":" Look at the line for anchors - replace them with links. ","code":"       "},{"number":164,"code":"        while (match = XRegExp.exec(newComment, this.anchorRegExp, pos, false)) {"},{"number":165,"code":"            newComment =  newComment.substr(0, match.index) +"},{"number":166,"code":"            \"[\" + match[1] + \"](#\" + match[1] + \")\" +"},{"number":167,"code":"            newComment.substr(match.index + match[0].length);"},{"number":168,"code":""},{"number":169,"code":"            pos = match.index + match[0].length;"},{"number":170,"code":"        }"},{"number":171,"code":""},{"number":172,"code":"        return newComment;"},{"number":173,"code":"    }"},{"number":174,"code":""},{"number":175,"longComment":true,"comment":""},{"number":176,"longComment":true,"comment":" ## Replace Links"},{"number":177,"longComment":true,"comment":" > Run this AFTER external link replacement to ensure warning accuracy"},{"number":178,"longComment":true,"comment":" Processes a comment line, replacing links with markdown links"},{"number":179,"comment":""},{"number":180,"code":"    replaceInternalLinks(comment: string, fileName: string, line: number) {"},{"number":181,"code":"        let pos = 0;"},{"number":182,"code":"        let match;"},{"number":183,"code":"        let newComment: string = comment;"},{"number":184,"code":""},{"number":185,"code":"        let linkPrefix = this.getLinkPrefix(fileName);"},{"number":186,"code":""},{"number":187,"comment":" Look at the line for anchors - replace them with links. ","code":"       "},{"number":188,"code":"        while (match = XRegExp.exec(newComment, this.linkRegExp, pos, false)) {"},{"number":189,"code":"            let tag =  _.findWhere(this.tags, {anchor: match[1]});"},{"number":190,"code":"            if (!tag) {"},{"number":191,"code":"                logger.warn(\"link: \" + match[1] + \" in \" + fileName + \":\" + line + \" does not have a cooresponding anchor, so link cannot be created.\");"},{"number":192,"code":"            } else {"},{"number":193,"code":"                logger.debug(\"found internal link: \" + match[1] + \" \" + tag.path);"},{"number":194,"code":"                newComment =  comment.substr(0, match.index) +"},{"number":195,"code":"                \" [\" + match[1] + \"](\" + linkPrefix + tag.path + \".md#\" + match[1] + \") \" +"},{"number":196,"code":"                newComment.substr(match.index + match[0].length);"},{"number":197,"code":"            }"},{"number":198,"code":"            pos = match.index + match[0].length;"},{"number":199,"code":"        }"},{"number":200,"code":""},{"number":201,"code":"        return newComment;"},{"number":202,"code":"    }"},{"number":203,"code":""},{"number":204,"longComment":true,"comment":""},{"number":205,"longComment":true,"comment":" ## Replace External Links"},{"number":206,"longComment":true,"comment":" > Run this BEFORE internal link replacement"},{"number":207,"longComment":true,"comment":" Processes a comment line, replacing links with markdown links to external urls"},{"number":208,"comment":""},{"number":209,"code":"    replaceExternalLinks(comment: string, fileName: string, line: number) {"},{"number":210,"code":"        let pos = 0;"},{"number":211,"code":"        let match;"},{"number":212,"code":"        let newComment: string = comment;"},{"number":213,"code":""},{"number":214,"comment":" Look at the line for external references - replace them with links. ","code":"       "},{"number":215,"code":"        while (match = XRegExp.exec(newComment, this.linkRegExp, pos, false)) {"},{"number":216,"code":"            let tagArray = match[1].split(\"/\");"},{"number":217,"code":"            let tag =  _.findWhere(this.externalReferences, {anchor: tagArray[0]});"},{"number":218,"code":""},{"number":219,"code":"            if (tag) {"},{"number":220,"code":"                logger.debug(\"found external link: \" + match[1]);"},{"number":221,"code":"                for (let i = 1; i < tagArray.length; i++) {"},{"number":222,"code":"                    tag.path = tag.path.replace(\"::\", tagArray[i]);"},{"number":223,"code":"                }"},{"number":224,"code":""},{"number":225,"code":"                newComment =  comment.substr(0, match.index - 1) +"},{"number":226,"code":"                \" [\" + match[1] + \"](\" + tag.path + \") \" +"},{"number":227,"code":"                newComment.substr(match.index + match[0].length);"},{"number":228,"code":"            }"},{"number":229,"code":""},{"number":230,"code":"            pos = match.index + match[0].length;"},{"number":231,"code":"        }"},{"number":232,"code":"        return newComment;"},{"number":233,"code":"    }"},{"number":234,"code":""},{"number":235,"longComment":true,"comment":""},{"number":236,"longComment":true,"comment":" ## Generates the \"Index Page\""},{"number":237,"longComment":true,"comment":" This generates the index page, listing all the link collections,"},{"number":238,"longComment":true,"comment":" and sucks in the README."},{"number":239,"comment":""},{"number":240,"code":"    generateIndexPage(readmeText?): void {"},{"number":241,"code":"        logger.info(\"generating Duly Noted Index file.\");"},{"number":242,"code":"        let that = this;"},{"number":243,"code":""},{"number":244,"code":"        let outputMap = {"},{"number":245,"code":"            project: this.projectName,"},{"number":246,"code":"            collections: [],"},{"number":247,"code":"            files: this.outputFiles,"},{"number":248,"code":"            readme: readmeText"},{"number":249,"code":"        };"},{"number":250,"code":""},{"number":251,"code":"        let collections = that.referenceCollection.getTagsByCollection();"},{"number":252,"code":""},{"number":253,"code":"        for (let i = 0; i < collections.length; i++) {"},{"number":254,"code":"            let anchors = _.clone(collections[i].anchors);"},{"number":255,"code":"            for (let x = 0; x < anchors.length; x++) {"},{"number":256,"code":"                let linkPrefix = that.getLinkPrefix(anchors[x].path);"},{"number":257,"code":"                anchors[x].path = anchors[x].path + \".md#\" + anchors[x].linkStub;"},{"number":258,"code":"            }"},{"number":259,"code":""},{"number":260,"code":"            let name = collections[i].name.split(\"/\");"},{"number":261,"code":"            name.shift();"},{"number":262,"code":"            name.shift();"},{"number":263,"code":"            name = name.join(\"/\");"},{"number":264,"code":""},{"number":265,"code":"            outputMap.collections.push({"},{"number":266,"code":"                name: name,"},{"number":267,"code":"                anchors: anchors"},{"number":268,"code":"            });"},{"number":269,"code":"        }"},{"number":270,"code":""},{"number":271,"code":"        let md = \"# \" + this.projectName + \" documentation \\n\";"},{"number":272,"code":""},{"number":273,"code":"        md += \"### Collections \\n\";"},{"number":274,"code":"        for (let i = 0; i < outputMap.collections.length; i++) {"},{"number":275,"code":"           md += \"\\n#### \" + outputMap.collections[i].name + \" \\n\";"},{"number":276,"code":""},{"number":277,"code":"           for (let x = 0; x < outputMap.collections[i].anchors.length; x++) {"},{"number":278,"code":"               md += \"* [\" + outputMap.collections[i].anchors[x].anchor + \"]\" + \"(\" + outputMap.collections[i].anchors[x].path + \") \\n\";"},{"number":279,"code":"           }"},{"number":280,"code":"        }"},{"number":281,"code":""},{"number":282,"code":"        md += \"\\n------------------------------ \\n\";"},{"number":283,"code":"        md += \"\\n### Files \\n\";"},{"number":284,"code":""},{"number":285,"code":"        for (let i = 0; i < outputMap.files.length; i++) {"},{"number":286,"code":""},{"number":287,"comment":" This shifts off the root folder b/c our index file is inside the output folder, ","code":"           "},{"number":288,"comment":" not one level up. See !issues/5","code":"           "},{"number":289,"comment":" > EXAMPLE: ","code":"           "},{"number":290,"comment":" > docs/myfile.ts.md is linked to as ./myfile.ts.md","code":"           "},{"number":291,"code":"            let path: any = outputMap.files[i].split(\"/\");"},{"number":292,"code":"            let name = path;"},{"number":293,"code":"            path.shift();"},{"number":294,"code":"            path.unshift(\".\");"},{"number":295,"code":"            path = path.join(\"/\");"},{"number":296,"code":"            name.shift();"},{"number":297,"code":"            name = name.join(\"/\");"},{"number":298,"code":""},{"number":299,"code":"            md += \"* [\" + name + \"](\" + path + \") \\n\";"},{"number":300,"code":"        }"},{"number":301,"code":"        md += \"\\n------------------------------ \\n\";"},{"number":302,"code":""},{"number":303,"code":"        md += outputMap.readme;"},{"number":304,"code":""},{"number":305,"code":"        writeFileSync(path.join(that.outputDir, \"Duly Noted.md\"), md, { flag: \"w\" });"},{"number":306,"code":"    }"},{"number":307,"code":""},{"number":308,"longComment":true,"comment":""},{"number":309,"longComment":true,"comment":" Generate a link Prefix from a fileName"},{"number":310,"longComment":true,"comment":" > NOTE: Without this code, links will not properly navigated to deeply nested pages with relative linking."},{"number":311,"comment":""},{"number":312,"code":"    getLinkPrefix(fileName: string): string {"},{"number":313,"code":"        let fileNameAsArray = fileName.split(\"/\");"},{"number":314,"code":"        let linkPrefix = \"\";"},{"number":315,"code":"        for (let i = 0; i < fileNameAsArray.length - 2; i++) {"},{"number":316,"code":"            linkPrefix += \"../\";"},{"number":317,"code":"        }"},{"number":318,"code":""},{"number":319,"code":"        return linkPrefix;"},{"number":320,"code":"    }"},{"number":321,"code":"}"},{"number":322,"code":""}],"type":"typescript"}